<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/salary.css') }}">
    <title>StoneSync | –ó–∞—Ä–∞–±–æ—Ç–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='image/stone.ico') }}">
</head>
<script>
    if (window.innerWidth < 768) {
        document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=device-width, initial-scale=0.4');
    } else {
        document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=device-width, initial-scale=1.0');
    }
</script>
<body>
    <header>
        <h1 class="title">–ó–∞—Ä–∞–±–æ—Ç–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h1>
        <a href="{{ url_for('main.index') }}" class="create-button">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </header>

    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    {% if salary_data.summary.total_orders > 0 %}
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <div class="stat-value">{{ salary_data.summary.total_orders }}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
                <div class="stat-value">{{ salary_data.summary.completed_orders }}</div>
                <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-content">
                <div class="stat-value">{{ "{:,}".format(salary_data.summary.total_salary).replace(',', ' ') }} ‚ÇΩ</div>
                <div class="stat-label">–û–±—â–∏–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
                <div class="stat-value">{{ salary_data.employees|length }}</div>
                <div class="stat-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <form method="GET" action="{{ url_for('main.salary') }}" class="filters-container">
        <table>
            <thead>
                <tr>
                    <th>
                        <div class="filter">
                            <img src="{{ url_for('static', filename='image/person.svg') }}" alt="–ò–∫–æ–Ω–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
                            <select id="filter-employee" name="employee">
                                <option value="" {% if not selected_employee %}selected{% endif %}>–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                                {% for employee in employees %}
                                <option value="{{ employee.id }}" {% if selected_employee == employee.id|string %}selected{% endif %}>{{ employee.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </th>
                    <th>
                        <div class="filter">
                            <img src="{{ url_for('static', filename='image/calendar.svg') }}" alt="–ò–∫–æ–Ω–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è">
                            <select id="period-type" name="period_type" style="width: 80px; margin-right: 0.5rem;">
                                <option value="month" {% if selected_period_type == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
                                <option value="year" {% if selected_period_type == 'year' %}selected{% endif %}>–ì–æ–¥</option>
                            </select>
                            <input type="month" id="filter-period" name="period" value="{{ selected_period }}" style="width: calc(100% - 90px);">
                            <input type="number" id="filter-year" name="year" value="{{ selected_year }}" min="2020" max="2030" style="width: calc(100% - 90px); display: none;" placeholder="–ì–æ–¥">
                        </div>
                    </th>
                    <th>
                        <div class="filter">
                            <img src="{{ url_for('static', filename='image/price.svg') }}" alt="–ò–∫–æ–Ω–∫–∞ —Ü–µ–Ω—ã">
                            <select id="filter-type" name="type">
                                <option value="all" {% if selected_type == 'all' %}selected{% endif %}>–í—Å–µ —Ä–∞–±–æ—Ç—ã</option>
                                <option value="izgotovlenie" {% if selected_type == 'izgotovlenie' %}selected{% endif %}>–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</option>
                                <option value="montaj" {% if selected_type == 'montaj' %}selected{% endif %}>–ú–æ–Ω—Ç–∞–∂</option>
                            </select>
                        </div>
                    </th>
                    <th>
                        <button type="submit" class="create-button" style="margin: 0;">–ü–æ–∫–∞–∑–∞—Ç—å</button>
                    </th>
                </tr>
            </thead>
        </table>
    </form>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ -->
    <table class="table-orders">
        <thead>
            <tr>
                <th class="col-employee">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                <th class="col-orders">–ó–∞–∫–∞–∑–æ–≤</th>
                <th class="col-izgotovlenie">–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ (‚ÇΩ)</th>
                <th class="col-montaj">–ú–æ–Ω—Ç–∞–∂ (‚ÇΩ)</th>
                <th class="col-total">–ò—Ç–æ–≥–æ (‚ÇΩ)</th>
                <th class="col-avg">–°—Ä–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑</th>
                <th class="col-period">–ü–µ—Ä–∏–æ–¥ —Ä–∞–±–æ—Ç—ã</th>
            </tr>
            <tr>
                <th colspan="7"><hr></th>
            </tr>
        </thead>
        <tbody>
            {% if salary_data.employees %}
                {% for employee_name, data in salary_data.employees.items() %}
                <tr class="employee-row" data-employee="{{ employee_name }}">
                    <td class="col-employee">
                        <div class="employee-info">
                            <strong>{{ employee_name }}</strong>
                            <small class="employee-stats">
                                {{ data.orders_count }} –∑–∞–∫–∞–∑–æ–≤ ‚Ä¢ 
                                {{ "{:,}".format(data.avg_order_value|round(0)).replace(',', ' ') }} ‚ÇΩ —Å—Ä–µ–¥–Ω–∏–π
                            </small>
                        </div>
                    </td>
                    <td class="col-orders">{{ data.orders_count }}</td>
                    <td class="col-izgotovlenie">{{ "{:,}".format(data.izgotovlenie_total).replace(',', ' ') if data.izgotovlenie_total > 0 else '-' }}</td>
                    <td class="col-montaj">{{ "{:,}".format(data.montaj_total).replace(',', ' ') if data.montaj_total > 0 else '-' }}</td>
                    <td class="col-total">{{ "{:,}".format(data.total_salary).replace(',', ' ') }}</td>
                    <td class="col-avg">{{ "{:,}".format(data.avg_order_value|round(0)).replace(',', ' ') }} ‚ÇΩ</td>
                    <td class="col-period">
                        {% if data.first_order_date and data.last_order_date %}
                            {% if data.first_order_date.strftime('%d.%m') == data.last_order_date.strftime('%d.%m') %}
                                {{ data.first_order_date.strftime('%d.%m.%Y') }}
                            {% else %}
                                {{ data.first_order_date.strftime('%d.%m') }} - {{ data.last_order_date.strftime('%d.%m.%Y') }}
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                <tr class="order-details" id="details-{{ employee_name|replace(' ', '-') }}" style="display: none;">
                    <td colspan="7">
                        <div class="order-details-content">
                            <h4>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–æ–≤ {{ employee_name }}:</h4>
                            <div class="orders-list">
                                {% for order in data.orders %}
                                <div class="order-item">
                                    <div class="order-header">
                                        <span class="order-id">#{{ order.id }}</span>
                                        <span class="order-type">{{ order.work_type }}</span>
                                        <span class="order-price">{{ "{:,}".format(order.price).replace(',', ' ') }} ‚ÇΩ</span>
                                        <span class="order-date">{{ order.finish_date.strftime('%d.%m.%Y') }}</span>
                                    </div>
                                    <div class="order-info">
                                        <div class="order-customer">{{ order.customer }}</div>
                                        <div class="order-address">{{ order.address }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="empty-state">–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
    {% if salary_data.summary.total_salary > 0 %}
    <div class="summary-box">
        <strong>–û–±—â–∏–π –∏—Ç–æ–≥: {{ "{:,}".format(salary_data.summary.total_salary).replace(',', ' ') }} ‚ÇΩ</strong>
        <small>
            –ó–∞–∫–∞–∑–æ–≤: {{ salary_data.summary.orders_count }} | 
            –ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: {{ "{:,}".format(salary_data.summary.izgotovlenie_total).replace(',', ' ') }} ‚ÇΩ | 
            –ú–æ–Ω—Ç–∞–∂: {{ "{:,}".format(salary_data.summary.montaj_total).replace(',', ' ') }} ‚ÇΩ
            {% if selected_period_type == 'month' and selected_period %}
            | –ü–µ—Ä–∏–æ–¥: {{ selected_period }}
            {% elif selected_period_type == 'year' and selected_year %}
            | –ì–æ–¥: {{ selected_year }}
            {% endif %}
        </small>
    </div>
    {% endif %}

    <script>
        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –º–µ—Å—è—Ü–µ–º –∏ –≥–æ–¥–æ–º
        function togglePeriodType() {
            const periodType = document.getElementById('period-type').value;
            const monthInput = document.getElementById('filter-period');
            const yearInput = document.getElementById('filter-year');
            
            if (periodType === 'month') {
                monthInput.style.display = 'inline-block';
                yearInput.style.display = 'none';
                monthInput.name = 'period';
                yearInput.name = 'year_disabled';
            } else {
                monthInput.style.display = 'none';
                yearInput.style.display = 'inline-block';
                monthInput.name = 'period_disabled';
                yearInput.name = 'year';
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            togglePeriodType();
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞/–≥–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥
            const periodType = document.getElementById('period-type').value;
            if (periodType === 'month' && !document.getElementById('filter-period').value) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                document.getElementById('filter-period').value = `${year}-${month}`;
            } else if (periodType === 'year' && !document.getElementById('filter-year').value) {
                const now = new Date();
                document.getElementById('filter-year').value = now.getFullYear();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–µ—Ä–∏–æ–¥–∞
        document.getElementById('period-type').addEventListener('change', function() {
            togglePeriodType();
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –ø–µ—Ä–∏–æ–¥–∞
            document.querySelector('form').submit();
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('filter-employee').addEventListener('change', function() {
            document.querySelector('form').submit();
        });
        
        document.getElementById('filter-period').addEventListener('change', function() {
            document.querySelector('form').submit();
        });
        
        document.getElementById('filter-year').addEventListener('change', function() {
            document.querySelector('form').submit();
        });
        
        document.getElementById('filter-type').addEventListener('change', function() {
            document.querySelector('form').submit();
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        document.querySelectorAll('.employee-row').forEach(row => {
            row.addEventListener('click', function() {
                const employeeName = this.getAttribute('data-employee');
                const detailsRow = document.getElementById(`details-${employeeName.replace(/ /g, '-')}`);
                if (detailsRow) {
                    const isVisible = detailsRow.style.display !== 'none';
                    detailsRow.style.display = isVisible ? 'none' : 'table-row';
                    this.classList.toggle('expanded', !isVisible);
                }
            });
        });
    </script>
</body>
</html> 